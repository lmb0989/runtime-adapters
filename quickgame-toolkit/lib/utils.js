"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function createRpkQrcode(e,t){if(e){var a=getIPAddress(),r="./dist";if("laya"==t)r="./release/quickgame/dist";else if("egret"==t){var o=process.cwd().split("/");r="../"+o[o.length-1]+"_quickgame/dist"}else"cocos"==t&&(r="./build/quickgame/dist");var n=(0,_child_process.spawn)("npx",["http-server",""+r,"-p",9999,"-a",a],{shell:"win32"==process.platform}),i=!1,l=debounce(function(){if(!i){i=!0;var t=e.length,r="http://"+a+":9999/"+e+"?pkg="+e.slice(0,t-4);_qrcodeTerminal2.default.generate(r)}});n.stdout.on("data",function(e){console.log(_chalk2.default.green(""+e)),l()}),n.stderr.on("data",function(e){console.error(_chalk2.default.red(""+e))})}}function debounce(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10,a=null;return function(){var r=this,o=arguments;clearTimeout(a),a=setTimeout(function(){e.apply(r,o)},t)}}function getIPAddress(){var e=_os2.default.networkInterfaces();for(var t in e){var a=e[t],r=!0,o=!1,n=void 0;try{for(var i,l=(0,_getIterator3.default)(a);!(r=(i=l.next()).done);r=!0){var s=i.value;if("IPv4"===s.family&&"127.0.0.1"!==s.address&&!s.internal)return s.address}}catch(e){o=!0,n=e}finally{try{!r&&l.return&&l.return()}finally{if(o)throw n}}}return null}function mkdirsSync(e){return!!_fsExtra2.default.existsSync(e)||(mkdirsSync(_path2.default.dirname(e))?(_fsExtra2.default.mkdirSync(e),!0):void 0)}function traverseDirSync(e,t){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;_fsExtra2.default.readdirSync(e).forEach(function(r){if(r=_path2.default.resolve(_path2.default.join(e,r)),a&&a.indexOf(r)>-1);else{var o=_fsExtra2.default.statSync(r);o&&o.isDirectory()?traverseDirSync(r,t,a):t.push(r)}})}function clearDirSync(e){var t=[];_fsExtra2.default.existsSync(e)&&(t=_fsExtra2.default.readdirSync(e),t.forEach(function(t,a){var r=e+"/"+t;_fsExtra2.default.statSync(r).isDirectory()?clearDirSync(r):_fsExtra2.default.unlinkSync(r)}),_fsExtra2.default.rmdirSync(e))}function loadBabelModule(e){var t=_path2.default.resolve(__dirname,"..","node_modules",e),a=_path2.default.resolve(process.cwd(),"node_modules",e);return _fsExtra2.default.existsSync(t)?t:_fsExtra2.default.existsSync(a)?a:e}function createMainifestJson(e,t,a,r){var o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"portrait",n=/^[a-zA-Z]+[0-9a-zA-Z_]*(\.[a-zA-Z]+[0-9a-zA-Z_]*)*$/,i={},l=!1;if(r&&r.packageName&&r.projectName||(console.log(_chalk2.default.red("lack suggestPackJson config")),_shelljs2.default.exit(1)),_fsExtra2.default.existsSync(_path2.default.join(t,"manifest.json")))l=!0,i=require(_path2.default.join(t,"manifest.json")),t!=a&&copyFiles(_path2.default.join(t,"manifest.json"),a),n.test(i.package)||(console.log(_chalk2.default.red("package incorrect in the file "+_path2.default.join(t,"manifest.json"))),_shelljs2.default.exit(1));else{i=require(_path2.default.join(e,"manifest.json"));var s=r.projectName,c=r.packageName;n.test(c)||(c="com.quickgame.demo",s="QuickgameDemo"),i.package=c,i.name=s,i.orientation=o;var f=(0,_stringify2.default)(i);_fsExtra2.default.writeFileSync(_path2.default.join(a,"manifest.json"),f)}return{option:i,manifestExist:l}}function getSuggestPackNameJson(e,t,a){if("cocos"===e){if(_fsExtra2.default.existsSync(_path2.default.join(a,".cocos-project.json"))){var r=null;try{r=require(_path2.default.join(a,".cocos-project.json"))}catch(e){}if(r&&r.projectName&&r.packageName)return{projectName:r.projectName,packageName:r.packageName}}}else if("egret"===e){var o=null,n=_path2.default.join(a,"project.config.json");if(_fsExtra2.default.existsSync(n)){try{o=require(n)}catch(e){}if(o&&o.projectname)return{projectName:o.projectname,packageName:o.projectname}}}var i=_path2.default.basename(t);return{projectName:i,packageName:"com."+i}}function copySignFile(e,t,a,r){var o=_path2.default.join(e,a.SIGN_DIR_NAME),n=_path2.default.resolve(t,"./sign");_fsExtra2.default.existsSync(o)||(console.log(_chalk2.default.yellow("### no sign files ### copy default to the project")),copyFiles(n,o));var i=r?a.SIGN_DEBUG_DIR:a.SIGN_RELEASE_DIR,l=_path2.default.join(o,i,a.PRIVATE_FILE_NAME),s=_path2.default.join(o,i,a.CERTIFICATE_FILE_NAME);return _fsExtra2.default.existsSync(l)&&_fsExtra2.default.existsSync(s)||(r?(console.log(_chalk2.default.yellow("### no sign files ### copy default to the project")),copyFiles(_path2.default.join(n,i),_path2.default.join(o,i))):(console.log(_chalk2.default.red("### no release sign files ### please make sure that the sign files exist:privatekey:"+l+", certificate:"+s)),_shelljs2.default.exit(1))),{privatekey:l,certificate:s}}function getOrientation(e,t){var a="portait";if("cocos"==t){var r=_path2.default.resolve(e,"./src/settings.js");if(_fsExtra2.default.existsSync(r)){global.window={};try{require(r),a=window._CCSettings&&window._CCSettings.orientation?window._CCSettings.orientation:a}catch(e){console.log(_chalk2.default.yellow("加载Settings文件失败，无法获得orientation"))}}}else if("laya"==t||"egret"==t){var o=_path2.default.resolve(e,"./game.json");if(_fsExtra2.default.existsSync(o))try{var n=require(o);a=n.deviceOrientation?n.deviceOrientation:a}catch(e){console.log(_chalk2.default.yellow("加载Settings文件失败，无法获得orientation"))}}return a}function mkBuildDirs(e,t,a,r,o,n){var i=_path2.default.resolve(e,"../",("egret"==o?getProjectName(t)+"_":"")+a.QUICKGAME_DIR),l=_path2.default.resolve(e,"../",a.QUICKGAME_DIR_TMP),s=_path2.default.join(i,a.DEST_DIR);_fsExtra2.default.emptyDirSync(l);var c=_path2.default.resolve(__dirname,"../"),f=_path2.default.join(c,"tpl"),u=_path2.default.join(c,o),d=getOrientation(e,o),_=createMainifestJson(f,i,l,getSuggestPackNameJson(o,t,e),d);if(r.DEFAULT_TPL_FILES&&r.DEFAULT_TPL_FILES.forEach(function(e){var t=_path2.default.join(i,e);_fsExtra2.default.existsSync(t)?copyFiles(t,l):copyFiles(_path2.default.join(f,e),l)}),_.option.icon){var p=_path2.default.resolve(_path2.default.join(i,_.option.icon));_fsExtra2.default.existsSync(p)?copyFiles(p,_path2.default.join(l,_path2.default.dirname(_.option.icon))):copyFiles(_path2.default.join(f,"logo.png"),l)}if(_fsExtra2.default.existsSync(_path2.default.join(i,a.SIGN_DIR_NAME))){var h=_path2.default.join(l,a.SIGN_DIR_NAME);copyFiles(_path2.default.join(i,a.SIGN_DIR_NAME),h)}_fsExtra2.default.emptyDirSync(i),copyFiles(l,i),_fsExtra2.default.existsSync(u)&&r.DEFAULT_TPL_FILES_JS&&r.DEFAULT_TPL_FILES_JS.forEach(function(e){copyFiles(_path2.default.join(u,e),i)}),_fsExtra2.default.ensureDirSync(s),console.log(_chalk2.default.green("[准备工作]build&dist 文件夹已删除, manifest配置文件已生成"));var y=copySignFile(i,c,a,n);return _fsExtra2.default.removeSync(l),{signFiles:y,distDir:s,quickgameDir:i,manifestJson:_}}function getProjectName(e){return _path2.default.basename(e).replace("wxgame","")}function copyFiles(e,t){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,o=arguments.length>4&&void 0!==arguments[4]&&arguments[4];if(_fsExtra2.default.statSync(e).isDirectory()){var n=[];r=r||[],traverseDirSync(e,n,r),n.forEach(function(r){var n=_path2.default.relative(e,r),i=_path2.default.resolve(_path2.default.join(t,n));_fsExtra2.default.existsSync(i)?o?_fsExtra2.default.copySync(r,i):console.log(_chalk2.default.white("[信息]文件: "+i+" 已存在")):a&&a.length>0&&a.indexOf(_path2.default.extname(r))>-1||_fsExtra2.default.copySync(r,i)})}else a&&a.length>0&&a.indexOf(_path2.default.extname(e))>-1||_fsExtra2.default.copySync(e,_path2.default.resolve(_path2.default.join(t,_path2.default.basename(e))))}Object.defineProperty(exports,"__esModule",{value:!0}),exports.colorconsole=void 0;var _stringify=require("babel-runtime/core-js/json/stringify"),_stringify2=_interopRequireDefault(_stringify),_getIterator2=require("babel-runtime/core-js/get-iterator"),_getIterator3=_interopRequireDefault(_getIterator2);exports.createRpkQrcode=createRpkQrcode,exports.debounce=debounce,exports.getIPAddress=getIPAddress,exports.mkdirsSync=mkdirsSync,exports.traverseDirSync=traverseDirSync,exports.clearDirSync=clearDirSync,exports.loadBabelModule=loadBabelModule,exports.createMainifestJson=createMainifestJson,exports.getSuggestPackNameJson=getSuggestPackNameJson,exports.copySignFile=copySignFile,exports.mkBuildDirs=mkBuildDirs,exports.copyFiles=copyFiles;var _path=require("path"),_path2=_interopRequireDefault(_path),_fsExtra=require("fs-extra"),_fsExtra2=_interopRequireDefault(_fsExtra),_chalk=require("chalk"),_chalk2=_interopRequireDefault(_chalk),_shelljs=require("shelljs"),_shelljs2=_interopRequireDefault(_shelljs),_os=require("os"),_os2=_interopRequireDefault(_os),_child_process=require("child_process"),_qrcodeTerminal=require("qrcode-terminal"),_qrcodeTerminal2=_interopRequireDefault(_qrcodeTerminal),colorconsole=exports.colorconsole={trace:function(){var e;(e=console).trace.apply(e,arguments)},log:function(){console.log(_chalk2.default.green.apply(_chalk2.default,arguments))},info:function(){console.info(_chalk2.default.green.apply(_chalk2.default,arguments))},warn:function(){var e;console.warn((e=_chalk2.default.yellow).bold.apply(e,arguments))},error:function(){var e;console.error((e=_chalk2.default.red).bold.apply(e,arguments))},throw:function(){var e;throw new Error((e=_chalk2.default.red).bold.apply(e,arguments))}};